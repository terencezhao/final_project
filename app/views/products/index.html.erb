<div class="page-header">
  <h1>
    <a href="/products/new" class="btn btn-lg btn-success">New Product</a>
  </h1>
</div>

<div class="row">
  <div class="col-md-12">
    <table class="table table-striped table-hover">
      <tr>
        <th><a href="/products/sorted/name">Product</a></th>
        <th><a href="/products/sorted/brand">Brand</a></th>
        <th><a href="/products/sorted/category">Category</a></th>
        <th><a href="/products/sorted/price">Price</a></th>
        <th><a href="/products/sorted/review">Review</a></th>
        <th><a href="/products/sorted/recommendation">Recommended</a></th>
        <!--<th>Thumb</th>-->
      </tr>
      <% sorted_products = case @sort_by %>
        <% when "name" %>
          <% @products_sorted_by_name %>
        <% when "brand" %>
          <% @products_sorted_by_brand %>
        <% when "category" %>
          <% @products_sorted_by_category %>      
        <% when "price" %>
          <% @products_sorted_by_price %>
        <% when "review" %>
          <% @products_sorted_by_review %>
        <% when "recommendation" %>
          <% @products_sorted_by_recommendation %>
        <% else %>
          <% @products %>
      <% end %>
      <% sorted_products.each do |product| %>
      <tr>
        <td><a href="/products/<%= product.id %>"><%= product.name %></td>
        <td><a href="/brands/<%= product.brand.id %>"><%= product.brand.name %></a></td>
        <td><a href="/categories/<%= product.category.id %>"><%= product.category.name %></a></td>
        <td><%= number_to_currency(product.price) %></td>
        <td>
          <% if product.reviews.empty? or product.reviews.all? { |review| review.user_id != current_user.id } %>
             <a href="/reviews/new/<%= product.id %>">Click to review this product!</a>
          <% else %>
             <a href="/reviews/for_product/<%= product.id %>">
             <% review_total = 0 %>
             <% product.reviews.each do |review| %>
               <% review_total += (review.quality + review.value + review.style + review.utility + review.enjoyment) / 5.0 %>
             <% end %>
             <% review_average = review_total / product.reviews.count %>
             <% puts case review_average %>
               <% when 4 %>
                 <%= "A" %>
               <% when 3.67..4.0 %>
                 <%= "A-" %>
               <% when 3.33..3.67 %>
                 <%= "B+" %>
               <% when 3.0..3.33 %>
                 <%= "B" %>
               <% when 2.67..3.0 %>
                 <%= "B-" %>
               <% when 2.33..2.67 %>
                 <%= "C+" %>
               <% when 2.0..2.33 %>
                 <%= "C" %>
               <% when 1.67..2.0 %>
                 <%= "C-" %>
               <% when 1.33..1.67 %>
                 <%= "D+" %>
               <% when 1.0..1.33 %>
                 <%= "D" %>
               <% when 0.67..1.0 %>
                 <%= "D-" %>
               <% when 0..0.67 %>
                 <%= "F" %>
               <% else %>
                 <%= "N/A" %>
             <% end %>
             <%= " (" + review_average.to_s + "/4.0)" %>
          <% end %>
        </td>
        <td>
          <% if product.reviews.empty? %>
            <%= "N/A" %>
          <% else %>
            <% recommend = 0.0 %>
            <% product.reviews.each do |review| %>
              <% if review.recommend %>
                <% recommend += 1.0 %>
              <% end %>
            <% end %>
            <%= number_to_percentage((recommend / product.reviews.count) * 100, precision: 0) %> (<%= recommend.to_i %> of <%= product.reviews.count %> Reviews)
          <% end %>
        </td>
        <!--<td>-->
        <!--  <a href="/products"><i class="fa fa-thumbs-o-up fa-3x" aria-hidden="true"></i></a>-->
        <!--  <a href="/products"><i class="fa fa-thumbs-o-down fa-3x" aria-hidden="true"></i></a>-->
        <!--</td>-->
      </tr>
      <% end %>
    </table>
  </div>
</div>
